{"version":3,"file":"sails.js","sourceRoot":"","sources":["../src/sails.ts"],"names":[],"mappings":"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","sourcesContent":["import SailsIO from \"sails.io.js\";\r\nimport * as SocketIO from \"socket.io-client\";\r\nimport { SailsResponse } from \"./sails.response\";\r\nimport { SailsConfig } from \"./sails.config\";\r\nimport { Inject, InjectionToken, Injector } from \"@angular/core\";\r\nimport { SailsIOClient } from \"./sails.io.client\";\r\nimport { SailsInterceptorConstructor, SailsInterceptorInterface } from \"./sails.interceptor\";\r\nimport { SailsInterceptorHandler, SailsInterceptorHandlerInterface } from \"./sails.interceptor.handler\";\r\nimport { SailsOptions } from \"./sails.options\";\r\nimport { isString } from \"./utils\";\r\nimport { SailsRequestOptions } from \"./sails.request.options\";\r\nimport { SailsEvent } from \"./sails.event\";\r\nimport { Observable } from \"rxjs\";\r\n\r\nexport const SAILS_OPTIONS = new InjectionToken(\"SAILS_OPTIONS\");\r\nexport const SAILS_INTERCEPTORS = new InjectionToken(\"SAILS_INTERCEPTORS\");\r\n\r\nexport const SailsEnvironment = {\r\n    DEV: \"development\",\r\n    PROD: \"production\"\r\n};\r\n\r\nexport const SailsListener = {\r\n    ERROR: \"error\",\r\n    CONNECT: \"connect\",\r\n    RECONNECT: \"reconnect\",\r\n    CONNECTING: \"connecting\",\r\n    DISCONNECT: \"disconnect\",\r\n    RECONNECTING: \"reconnecting\",\r\n    CONNECT_ERROR: \"connect_error\",\r\n    CONNECT_TIMEOUT: \"connect_timeout\",\r\n};\r\n\r\nexport class Sails implements SailsInterceptorInterface, SailsInterceptorHandlerInterface {\r\n    private Socket: SailsIOClient.Socket;\r\n    private Config: SailsConfig;\r\n    private Listeners: { [eventName: string]: ((data: any) => void)[] } = {\r\n        [SailsListener.CONNECT]: [],\r\n        [SailsListener.CONNECT_ERROR]: [],\r\n        [SailsListener.CONNECT_TIMEOUT]: [],\r\n        [SailsListener.CONNECTING]: [],\r\n        [SailsListener.RECONNECT]: [],\r\n        [SailsListener.RECONNECTING]: [],\r\n        [SailsListener.DISCONNECT]: [],\r\n        [SailsListener.ERROR]: [],\r\n    };\r\n\r\n    private get socket(): SailsIOClient.Socket {\r\n        return this.Socket;\r\n    }\r\n\r\n    private set socket(Socket: SailsIOClient.Socket) {\r\n        this.Socket = Socket;\r\n    }\r\n\r\n    constructor(\r\n        @Inject(Injector) private injector: Injector,\r\n        @Inject(SAILS_OPTIONS) options: SailsOptions,\r\n        @Inject(SAILS_INTERCEPTORS) private Interceptors: SailsInterceptorConstructor[] = []) {\r\n\r\n        const io: SailsIOClient.IO = SailsIO(SocketIO);\r\n        const socket = io.socket;\r\n\r\n        // Helper function for Listeners\r\n        const handleListeners = eventName => data => {\r\n            this.Listeners[eventName].forEach(callback => callback(data));\r\n        };\r\n        // Set up Event Listeners\r\n        socket.on(SailsListener.CONNECT, handleListeners(SailsListener.CONNECT));\r\n        socket.on(SailsListener.CONNECT_ERROR, handleListeners(SailsListener.CONNECT_ERROR));\r\n        socket.on(SailsListener.CONNECT_TIMEOUT, handleListeners(SailsListener.CONNECT_TIMEOUT));\r\n        socket.on(SailsListener.CONNECTING, handleListeners(SailsListener.CONNECTING));\r\n        socket.on(SailsListener.RECONNECT, handleListeners(SailsListener.RECONNECT));\r\n        socket.on(SailsListener.ERROR, handleListeners(SailsListener.ERROR));\r\n        socket.on(SailsListener.RECONNECTING, handleListeners(SailsListener.RECONNECTING));\r\n        socket.on(SailsListener.DISCONNECT, handleListeners(SailsListener.DISCONNECT));\r\n\r\n        // Setup Config\r\n        const Config = new SailsConfig(options);\r\n        // Merge Config with Sails\r\n        Object.assign(io.sails, Config);\r\n\r\n        this.socket = socket;\r\n        this.Config = Config;\r\n    }\r\n\r\n    public connect(): Sails {\r\n        if (!this.connected()) {\r\n            this.socket._connect();\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    public connected(): boolean {\r\n        return this.socket.isConnected();\r\n    }\r\n\r\n    public isConnecting(): Sails {\r\n        this.socket.isConnecting();\r\n        return this;\r\n    }\r\n\r\n    public disconnect(): Sails {\r\n        if (this.connected()) {\r\n            this.socket.disconnect();\r\n        }\r\n        return this;\r\n    }\r\n\r\n    public addEventListener(eventName: string, callback: (data: string) => void): this {\r\n        if (!this.Listeners[eventName]) {\r\n            throw new Error(`The event [${eventName}] has not yet been supported by this library.`);\r\n        }\r\n        this.Listeners[eventName].push(callback);\r\n        return this;\r\n    }\r\n\r\n    public removeEventListener(eventName: string, callback): this {\r\n        if (!this.Listeners[eventName]) {\r\n            throw new Error(`The event [${eventName}] has not yet been supported by this library.`);\r\n        }\r\n        if (this.Listeners[eventName].indexOf(callback) > -1) {\r\n            this.Listeners[eventName].splice(this.Listeners[eventName].indexOf(callback), 1);\r\n        }\r\n        return this;\r\n    }\r\n\r\n    public on(eventName: string): Observable<SailsEvent> {\r\n        return new Observable((obs) => {\r\n            this.socket.on(eventName, response => {\r\n                if (response) {\r\n                    const event = new SailsEvent(response);\r\n                    obs.next(event);\r\n                    this.debugReqRes(eventName, event);\r\n                }\r\n            });\r\n            return () => this.socket.off(eventName, () => { });\r\n        });\r\n    }\r\n\r\n    public off(eventName: string): Observable<SailsEvent> {\r\n        return new Observable((obs) => {\r\n            this.socket.off(eventName, response => {\r\n                if (response) {\r\n                    const event = new SailsEvent(response);\r\n                    obs.next(event);\r\n                    this.debugReqRes(eventName, event);\r\n                }\r\n                return () => { };\r\n            });\r\n        });\r\n    }\r\n\r\n    public request(request: SailsRequestOptions): Observable<SailsResponse> {\r\n        const req = request.clone({\r\n            url: this.Config.prefix + request.url,\r\n        });\r\n\r\n        return this.intercept(req);\r\n    }\r\n\r\n    intercept(request: SailsRequestOptions, next: SailsInterceptorHandlerInterface = this): Observable<SailsResponse> {\r\n        const handler = this.Interceptors.reduceRight((next: SailsInterceptorHandlerInterface, interceptor) => {\r\n            return new SailsInterceptorHandler(next, this.injector.get(interceptor));\r\n        }, next);\r\n\r\n        return handler.handle(request);\r\n    }\r\n\r\n    handle(request: SailsRequestOptions): Observable<SailsResponse> {\r\n        return new Observable<SailsResponse>((obs) => {\r\n            this.socket.request(request.serialize(), (body: any, jwr: SailsIOClient.JWR.Response) => {\r\n                const response = new SailsResponse(jwr);\r\n                if (response.isError()) {\r\n                    obs.error(response.getError());\r\n                } else {\r\n                    obs.next(response);\r\n                }\r\n\r\n                obs.complete();\r\n                this.debugReqRes(request, response);\r\n            });\r\n        });\r\n    }\r\n\r\n    private debugReqRes(request, response) {\r\n        if (this.Config.environment === SailsEnvironment.DEV) {\r\n            console.groupCollapsed(\"[SailsSocketIO] > Debug Output\");\r\n            isString(request) ? console.log(request) : console.dir(request);\r\n            console.dir(response);\r\n            console.groupEnd();\r\n        }\r\n    }\r\n}\r\n"]}